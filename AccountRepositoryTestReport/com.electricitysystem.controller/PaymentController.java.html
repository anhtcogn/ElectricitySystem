<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PaymentController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">InvoiceRepositoryTest Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.electricitysystem.controller</a> &gt; <span class="el_source">PaymentController.java</span></div><h1>PaymentController.java</h1><pre class="source lang-java linenums">package com.electricitysystem.controller;

import com.electricitysystem.entity.ElectricBoardEntity;
import com.electricitysystem.entity.InvoiceEntity;
import com.electricitysystem.repository.InvoiceRepository;
import com.electricitysystem.service.ElectricBoardService;
import com.electricitysystem.service.InvoiceService;
import com.electricitysystem.service.PayWithCashService;
import com.electricitysystem.service.PayWithPaypalService;
import com.paypal.api.payments.Links;
import com.paypal.api.payments.Payment;
import com.paypal.base.rest.PayPalRESTException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;


@RestController
@RequestMapping(&quot;/&quot;)
<span class="fc" id="L21">public class PaymentController {</span>
    public static final String PAYPAL_SUCCESS_URL = &quot;pay/success&quot;;
    public static final String PAYPAL_CANCEL_URL = &quot;pay/cancel&quot;;

    @Autowired
    private InvoiceRepository invoiceRepository;

    @Autowired
    private InvoiceService invoiceService;
    @Autowired
    private PayWithPaypalService payWithPaypalService;
    @Autowired
    private ElectricBoardService electricBoardService;
    @Autowired
    private PayWithCashService payWithCashService;
    @PostMapping(&quot;/pay&quot;)
    public String payment(@RequestParam int id) {
<span class="nc" id="L38">        String token = &quot;&quot;;</span>
        try {
<span class="nc" id="L40">            ElectricBoardEntity electricBoard = electricBoardService.getOneById(id);</span>
<span class="nc" id="L41">            Payment payment = payWithPaypalService.createPayment(electricBoard.getTotalPayment() / 23447, &quot;USD&quot;, &quot;paypal&quot;,</span>
                    &quot;sale&quot;, &quot;thanh toan tien dien&quot;
                    , &quot;http://localhost:9090/&quot; + PAYPAL_CANCEL_URL,
                    &quot;http://localhost:9090/&quot; + PAYPAL_SUCCESS_URL);
<span class="nc" id="L45">            System.out.println(payment);</span>
<span class="nc" id="L46">            InvoiceEntity invoice = invoiceService.getById(id);</span>
<span class="nc" id="L47">            invoice.setStatus(&quot;PAYMENT PENDING&quot;);</span>
//            invoiceRepository.save(invoice);

<span class="nc bnc" id="L50" title="All 2 branches missed.">            for(Links link:payment.getLinks()) {</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">                if(link.getRel().equals(&quot;approval_url&quot;)) {</span>
<span class="nc" id="L52">                    String[] s = link.getHref().split(&quot;=&quot;);</span>
<span class="nc" id="L53">                    token = s[2];</span>
<span class="nc" id="L54">                    invoice.setToken(token);</span>
<span class="nc" id="L55">                    invoiceRepository.save(invoice);</span>
<span class="nc" id="L56">                    return link.getHref();</span>
                }
<span class="nc" id="L58">            }</span>

<span class="nc" id="L60">        } catch (PayPalRESTException e) {</span>
<span class="nc" id="L61">            e.printStackTrace();</span>
<span class="nc" id="L62">        }</span>
<span class="nc" id="L63">        return &quot;payment pending&quot;;</span>
    }

    @GetMapping(value = PAYPAL_CANCEL_URL)
    public String cancelPay(
            @RequestParam(&quot;token&quot;) String token
    ) {
<span class="nc" id="L70">        InvoiceEntity invoice = invoiceService.getByToken(token);</span>
<span class="nc" id="L71">        invoice.setPaymentDate(LocalDateTime.now());</span>
<span class="nc" id="L72">        invoice.setStatus(&quot;UNPAID&quot;);</span>
<span class="nc" id="L73">        invoiceRepository.save(invoice);</span>
<span class="nc" id="L74">        return &quot;payment failed&quot;;</span>
    }
    @GetMapping(value = PAYPAL_SUCCESS_URL)
    public String successPay(
            @RequestParam(&quot;paymentId&quot;) String paymentId,
            @RequestParam(&quot;token&quot;) String token,
            @RequestParam(&quot;PayerID&quot;) String payerId) {
        try {
<span class="nc" id="L82">            Payment payment = payWithPaypalService.executePayment(paymentId, payerId);</span>
<span class="nc" id="L83">            System.out.println(payment.toJSON());</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (payment.getState().equals(&quot;approved&quot;)) {</span>
<span class="nc" id="L85">                InvoiceEntity invoice = invoiceService.getByToken(token);</span>
<span class="nc" id="L86">                invoice.setPaymentDate(LocalDateTime.now());</span>
<span class="nc" id="L87">                invoice.setStatus(&quot;PAID&quot;);</span>
<span class="nc" id="L88">                invoiceRepository.save(invoice);</span>
<span class="nc" id="L89">                return &quot;payment success&quot;;</span>
            }
<span class="nc" id="L91">        } catch (PayPalRESTException e) {</span>
<span class="nc" id="L92">            System.out.println(e.getMessage());</span>
<span class="nc" id="L93">        }</span>
<span class="nc" id="L94">        return &quot;payment success&quot;;</span>
    }

    @PostMapping(&quot;payWithCash&quot;)
    public String payWithCash(
            @RequestParam int id
    ) {
<span class="nc" id="L101">        return payWithCashService.payWithCash(id);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>